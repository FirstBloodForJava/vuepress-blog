import{_ as a,c as e,e as s,o}from"./app-DO9Fsueg.js";const t={};function i(c,n){return o(),e("div",null,n[0]||(n[0]=[s(`<h1 id="嵌入式容器starter" tabindex="-1"><a class="header-anchor" href="#嵌入式容器starter"><span>嵌入式容器starter</span></a></h1><h2 id="servlet自动配置" tabindex="-1"><a class="header-anchor" href="#servlet自动配置"><span>Servlet自动配置</span></a></h2><ul><li>DispatcherServletAutoConfiguration</li><li>ServletWebServerFactoryAutoConfiguration</li><li>ErrorMvcAutoConfiguration</li><li>HttpEncodingAutoConfiguration</li><li>MultipartAutoConfiguration</li><li>WebMvcAutoConfiguration</li></ul><h3 id="_1-servletwebserverfactoryautoconfiguration" tabindex="-1"><a class="header-anchor" href="#_1-servletwebserverfactoryautoconfiguration"><span>1.ServletWebServerFactoryAutoConfiguration</span></a></h3><p>org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryAutoConfiguration</p><h4 id="_1-import" tabindex="-1"><a class="header-anchor" href="#_1-import"><span>1.Import</span></a></h4><p>使用<code>@Import</code>注册<code>ImportBeanDefinitionRegistrar(ServletWebServerFactoryAutoConfiguration.BeanPostProcessorsRegistrar)</code>，注册<code>ServletWebServerFactory</code>，用于创建<code>WebServer</code>的工厂。Servlet容器加载顺序：</p><ol><li>Tomcat：<code>TomcatServletWebServerFactory</code>，往工厂添加定义器：<code>TomcatConnectorCustomizer</code>、<code>TomcatContextCustomizer</code>、<code>TomcatProtocolHandlerCustomizer</code>。可用在创建或启动容器对容器进行自定义的操作</li><li>Jetty：<code>JettyServletWebServerFactory</code>，往工厂添加自定义器：<code>JettyServerCustomizer</code>。</li><li>Undertow：往<code>UndertowServletWebServerFactory</code>工厂添加自定义器：<code>UndertowDeploymentInfoCustomizer</code>、<code>UndertowBuilderCustomizer</code>：对<code>Builder</code>进行自定义，从而达到对Undertow容器进行自定义操作。</li></ol><p><strong>导入<code>ImportBeanDefinitionRegistrar</code>作用？</strong></p><p>通过注册<code>WebServerFactoryCustomizerBeanPostProcessor</code>Bean后置处理器，在创建Server容器之前，根据配置对ServerFactory工厂进行配置。</p><h4 id="_2-webserverfactorycustomizer" tabindex="-1"><a class="header-anchor" href="#_2-webserverfactorycustomizer"><span>2.WebServerFactoryCustomizer</span></a></h4><p>创建<code>ServletWebServerFactoryCustomizer</code> Bean，获取ServerProperties(server.)配置类信息。</p><p>设计<code>PropertyMapper</code>替换了if-else写法，设置工厂的配置。</p><p>对ServerFacotry工厂进行<strong>公共</strong>初始化配置。</p><ol><li>端口</li><li>绑定地址</li><li>Servlet上下文地址</li><li>应用名称</li><li>Session配置</li><li>是否ssl协议配置</li><li>是否配置Servlet JSP</li><li>是否压缩配置</li><li>是否http2协议配置</li><li><code>server.serverHeader</code>配置</li><li>Servlet上下文初始化参数<code>server.servlet</code></li></ol><figure><img src="http://47.101.155.205/image-20250407210032896.png" alt="image-20250407210032896" tabindex="0" loading="lazy"><figcaption>image-20250407210032896</figcaption></figure><p>如果是tomcat Servlet，则还创建<code>TomcatServletWebServerFactoryCustomizer</code> Bean。<strong>匹配条件是WebServerFactory对象的父类。</strong></p><figure><img src="http://47.101.155.205/image-20250407211430258.png" alt="image-20250407211430258" tabindex="0" loading="lazy"><figcaption>image-20250407211430258</figcaption></figure><h4 id="_3-forwardedheaderfilter" tabindex="-1"><a class="header-anchor" href="#_3-forwardedheaderfilter"><span>3.ForwardedHeaderFilter</span></a></h4><p>是否配置<code>ForwardedHeaderFilter</code>过滤器，通过<code>FilterRegistrationBean</code>注册。</p><p>过滤器优先级是最高的。</p><figure><img src="http://47.101.155.205/image-20250407212949015.png" alt="image-20250407212949015" tabindex="0" loading="lazy"><figcaption>image-20250407212949015</figcaption></figure><h3 id="_2-dispatcherservletautoconfiguration" tabindex="-1"><a class="header-anchor" href="#_2-dispatcherservletautoconfiguration"><span>2.DispatcherServletAutoConfiguration</span></a></h3><p>org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration</p><p>通过在<code>@Conditional</code>指向类上的<code>@Order</code>的注解，来决定匹配的执行顺序。</p><figure><img src="http://47.101.155.205/image-20250408145906476.png" alt="image-20250408145906476" tabindex="0" loading="lazy"><figcaption>image-20250408145906476</figcaption></figure><h4 id="_1-dispatcherservletconfiguration" tabindex="-1"><a class="header-anchor" href="#_1-dispatcherservletconfiguration"><span>1.DispatcherServletConfiguration</span></a></h4><p>激活(导入)配置类<code>HttpProperties(spring.http)</code>、<code>WebMvcProperties(spring.mvc)</code>。</p><p>匹配成功条件，Bean名称<code>dispatcherServlet</code>未被占用、<code>dispatcherServlet</code>名称的DispatcherServlet Bean不存在。</p><figure><img src="http://47.101.155.205/image-20250408154856969.png" alt="image-20250408154856969" tabindex="0" loading="lazy"><figcaption>image-20250408154856969</figcaption></figure><figure><img src="http://47.101.155.205/image-20250408153847017.png" alt="image-20250408153847017" tabindex="0" loading="lazy"><figcaption>image-20250408153847017</figcaption></figure><p><strong>1.创建DispatcherServlet Bean，做如下设置：</strong></p><ol><li>设置是否允许<code>OPTIONS</code>请求到FrameworkServlet.doService方法，默认<code>spring.mvc.dispatchOptionsRequest</code>为true。</li><li>设置是否允许<code>TRACE</code>请求到FrameworkServlet.doService方法，默认<code>spring.mvc.dispatchTraceRequest</code>为false。</li><li>没有找到请求的Handler，是否抛出<code>NoHandlerFoundException</code>，默认<code>spring.mvc.throwExceptionIfNoHandlerFound</code>为false。true则可以通过指定全局异常的方式处理指定异常。如果使用<code>DefaultServletHttpRequestHandler</code>处理请求，则不会抛出该异常。</li><li>在每个请求结束是否发布<code>ServletRequestHandledEvent</code>事件，默认<code>spring.mvc.publishRequestHandledEvents</code>为true。在没有<code>ApplicationListener</code>监听该事件的前提下，可以关闭，<strong>提升性能</strong>。</li><li>是否<code>DEBUG</code>日志记录请求参数，<code>TRACE</code>日志记录请求头。默认<code>spring.http.logRequestDetails</code>为false。</li></ol><p><strong>2.修改MultipartResolver Bean的名称(Bean 存在)</strong></p><h4 id="_2-dispatcherservletregistrationconfiguration" tabindex="-1"><a class="header-anchor" href="#_2-dispatcherservletregistrationconfiguration"><span>2.DispatcherServletRegistrationConfiguration</span></a></h4><p>匹配成功条件与<code>DispatcherServlet</code>的相似，多了一个DispatcherServlet Bean的判断条件。</p><figure><img src="http://47.101.155.205/image-20250408160041426.png" alt="image-20250408160041426" tabindex="0" loading="lazy"><figcaption>image-20250408160041426</figcaption></figure><p><strong>创建DispatcherServletRegistrationBean Bean，条件是存在名称dispatcherServlet 的DispatcherServlet Bean：</strong></p><figure><img src="http://47.101.155.205/image-20250408161516272.png" alt="image-20250408161516272" tabindex="0" loading="lazy"><figcaption>image-20250408161516272</figcaption></figure><ol><li>创建<code>DispatcherServletRegistrationBean</code>，设置<code>spring.mvc.servlet.path</code>地址，默认<code>/</code>。</li><li>设置注册的名称<code>dispatcherServlet</code>。</li><li>设置Servlet调度的优先级<code>spring.mvc.servlet.loadOnStartup</code>，默认-1。</li><li><code>MultipartConfigElement</code> Bean存在则设置，该属性。</li></ol><h3 id="_3-errormvcautoconfiguration" tabindex="-1"><a class="header-anchor" href="#_3-errormvcautoconfiguration"><span>3.ErrorMvcAutoConfiguration</span></a></h3><p>org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration</p><p>激活/导入<code>ServerProperties(server)</code>、<code>ResourceProperties(spring.resources)</code>、<code>WebMvcProperties(spring.mvc)</code>配置类。</p><h4 id="_1-bean" tabindex="-1"><a class="header-anchor" href="#_1-bean"><span>1.Bean</span></a></h4><ol><li>创建<code>DefaultErrorAttributes</code> Bean，设置属性<code>server.error.includeException</code>，是否包含异常属性，默认false。</li><li>当前上限文不存在<code>ErrorController</code> Bean，创建<code>BasicErrorController</code> Controller。设置存在的错误视图解析器<code>ErrorViewResolver</code>，当前请求接收内容<code>text/html</code>才使用。处理错误请求，默认<code>/error</code>，可通过<code>server.error.path</code>、<code>error.path</code>配置路径。</li><li>创建<code>ErrorPageCustomizer</code> Bean，可以自定义<code>ErrorPageRegistrar</code>，<code>ErrorPageRegistrarBeanPostProcessor</code>回调，注册这些错误页面。</li><li>创建<code>PreserveErrorControllerTargetClassPostProcessor</code>，<code>BeanFactoryPostProcessor</code>实例。</li></ol><p><code>BeanFactoryPostProcessor</code>的作用？</p><h4 id="_2-defaulterrorviewresolverconfiguration" tabindex="-1"><a class="header-anchor" href="#_2-defaulterrorviewresolverconfiguration"><span>2.DefaultErrorViewResolverConfiguration</span></a></h4><p>不存在<code>ErrorViewResolver</code> Bean，则创建<code>DefaultErrorViewResolver</code> Bean。</p><p><strong>优先级最低</strong></p><figure><img src="http://47.101.155.205/image-20250408164614340.png" alt="image-20250408164614340" tabindex="0" loading="lazy"><figcaption>image-20250408164614340</figcaption></figure><h4 id="_3-whitelabelerrorviewconfiguration" tabindex="-1"><a class="header-anchor" href="#_3-whitelabelerrorviewconfiguration"><span>3.WhitelabelErrorViewConfiguration</span></a></h4><p>创建默认错误(error)视图。</p><p><code>@Conditional(ErrorTemplateMissingCondition.class)</code>没有错误(error)模板才匹配。</p><ol><li>创建默认<code>text/html</code>错误视图。</li><li>不存在<code>BeanNameViewResolver</code> Bean才创建。</li></ol><figure><img src="http://47.101.155.205/image-20250408165302132.png" alt="image-20250408165302132" tabindex="0" loading="lazy"><figcaption>image-20250408165302132</figcaption></figure><h3 id="_4-webmvcautoconfiguration" tabindex="-1"><a class="header-anchor" href="#_4-webmvcautoconfiguration"><span>4.WebMvcAutoConfiguration</span></a></h3><p>org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration</p><p><code>WebMvcConfigurationSupport</code> Bean 不存在才匹配。</p><p>在以下配置类之后配置：</p><ul><li>DispatcherServletAutoConfiguration</li><li>TaskExecutionAutoConfiguration：Spring上下文注册线程池。</li><li>ValidationAutoConfiguration：？</li></ul><h4 id="_1-bean-1" tabindex="-1"><a class="header-anchor" href="#_1-bean-1"><span>1.Bean</span></a></h4><p>Bean不存在才匹配。</p><ol><li>注入Web过滤器<code>OrderedHiddenHttpMethodFilter(-10000)</code>：<code>spring.mvc.hiddenmethod.filter.enabled</code>默认false。将POST请求，在携带<code>_method</code>请求参数的情况下，转换http请求方式。</li><li>Web过滤器<code>OrderedFormContentFilter(-9900)</code>：<code>spring.mvc.formcontent.filter.enable</code>默认开启，将<code>PUT/PATCH/DELETE</code>请求的表达数据解析到Servlet 请求参数中。</li></ol><figure><img src="http://47.101.155.205/image-20250408193201029.png" alt="image-20250408193201029" tabindex="0" loading="lazy"><figcaption>image-20250408193201029</figcaption></figure><h4 id="_2-webmvcautoconfigurationadapter" tabindex="-1"><a class="header-anchor" href="#_2-webmvcautoconfigurationadapter"><span>2.WebMvcAutoConfigurationAdapter</span></a></h4><p><code>WebMvcConfigurer</code>接口实现。</p><p>Import <code>EnableWebMvcConfiguration</code></p><p>重写了接口的部分方法：</p><ul><li>configureMessageConverters：</li><li>configureAsyncSupport：</li><li>configurePathMatch：</li><li>configureContentNegotiation：</li><li>getMessageCodesResolver</li><li>addFormatters</li><li>addResourceHandlers</li></ul><p>注入Bean(不存在才注入)：</p><ol><li>InternalResourceViewResolver：配置视图前缀后缀<code>spring.mvc.view.prefix/spring.mvc.view.suffix</code>。</li><li>BeanNameViewResolver：存在<code>View</code> Bean匹配。</li><li>ContentNegotiatingViewResolver：视图解析分发器。</li><li>LocaleResolver：<code>spring.mvc.locale</code>配置才有效。</li><li>过滤器<code>RequestContextListener(-105)</code>：使用<code>ThreadLocal</code>缓存请求上下文。</li></ol><h4 id="_3-enablewebmvcconfiguration" tabindex="-1"><a class="header-anchor" href="#_3-enablewebmvcconfiguration"><span>3.EnableWebMvcConfiguration</span></a></h4><p><code>EnableWebMvcConfiguration</code>实现<code>DelegatingWebMvcConfiguration</code>，相当于<code>@EnableWebMvc</code>作用。</p><p>注入Bean：</p><ol><li><code>RequestMappingHandlerAdapter</code>：</li><li><code>RequestMappingHandlerMapping</code>：</li><li><code>WelcomePageHandlerMapping</code>：</li><li><code>FormattingConversionService</code>：</li><li><code>Validator</code>：</li><li><code>ContentNegotiationManager</code>：</li></ol><h4 id="_4-resourcechaincustomizerconfiguration" tabindex="-1"><a class="header-anchor" href="#_4-resourcechaincustomizerconfiguration"><span>4.ResourceChainCustomizerConfiguration</span></a></h4><p>要一定条件才匹配。</p><p>注入<code>ResourceChainResourceHandlerRegistrationCustomizer</code> Bean。</p><h3 id="_5-httpencodingautoconfiguration" tabindex="-1"><a class="header-anchor" href="#_5-httpencodingautoconfiguration"><span>5.HttpEncodingAutoConfiguration</span></a></h3><p>org.springframework.boot.autoconfigure.web.servlet.HttpEncodingAutoConfiguration</p><p>获取<code>spring.http.encoding</code>字符编码相关配置。</p><p>注入<code>CharacterEncodingFilter(Integer.MIN_VALUE)</code>过滤器：默认使用<code>UTF-8</code>字符编码，请求使用强制编码，响应不使用。</p><p>注入<code>LocaleCharsetMappingsCustomizer</code>：根据<code>spring.http.encoding.mapping</code>配置，实现不同区域使用不同的字符编码。</p><h3 id="_6-multipartautoconfiguration" tabindex="-1"><a class="header-anchor" href="#_6-multipartautoconfiguration"><span>6.MultipartAutoConfiguration</span></a></h3><p>org.springframework.boot.autoconfigure.web.servlet.MultipartAutoConfiguration</p><p>导入<code>MultipartProperties(spring.servlet.multipart)</code>配置。</p><p>注入<code>MultipartConfigElement</code> Bean：</p><ul><li>匹配条件：<code>MultipartConfigElement</code>和<code>CommonsMultipartResolver</code>Bean都不存在。</li><li>使用<code>MultipartProperties</code>配置文件上传功能：写入磁盘大小阈值、存储文件的目录、多媒体表单的最大大小(默认10MB)、上传文件的最大大小(默认1MB)。</li></ul><p>注入<code>StandardServletMultipartResolver</code>：</p><ul><li>匹配条件：<code>MultipartResolver</code> Bean 不存在。</li><li>创建<code>StandardServletMultipartResolver</code> Bean，配置<code>spring.servlet.multipart.resolveLazily</code>，是否在文件或参数访问multipart请求时延迟解析。</li></ul><h2 id="embedded自动配置" tabindex="-1"><a class="header-anchor" href="#embedded自动配置"><span>embedded自动配置</span></a></h2><p>org.springframework.boot.autoconfigure.web.embedded.EmbeddedWebServerFactoryCustomizerAutoConfiguration</p><p>使用嵌入式容器的顺序：</p><ol><li>Tomcat：</li><li>Jetty：</li><li>Undertow：</li><li>使用嵌入式reactor netty：</li></ol><p><strong>Tomcat容器存在：</strong></p><p>创建<code>TomcatWebServerFactoryCustomizer</code>实例，是WebServerFactoryCustomizer&lt;ConfigurableTomcatWebServerFactory&gt;抽象类实现。</p><p>通过导入<code>BeanPostProcessorsRegistrar(ImportBeanDefinitionRegistrar)</code>，注册<code>WebServerFactoryCustomizerBeanPostProcessor(BeanPostProcessor)</code>重写了<code>postProcessBeforeInitialization</code>方法，在<code>WebServerFactory</code> Bean创建后，调用<code>TomcatWebServerFactoryCustomizer</code>重写的<code>customize</code>方法。</p><p><strong>Undertow容器存在：</strong></p><p>创建<code>UndertowWebServerFactoryCustomizer</code>实例，是WebServerFactoryCustomizer&lt;ConfigurableUndertowWebServerFactory&gt;的实现。对Undertow容器根据配置进行自定义操作。原理同Tomcat容器。</p><h2 id="tomcat容器启动" tabindex="-1"><a class="header-anchor" href="#tomcat容器启动"><span>Tomcat容器启动</span></a></h2><p>ServletWeb应用，创建<code>ServletWebServerApplicationContext</code>上下文对象，调用<code>refresh()</code>。方法中调用<code>onRefresh()</code>创建Tomcat 容器。获取上下文<code>ServletWebServerFactory</code> Bean，用来创建SpringBoot定义的<code>WebServer</code>对象。</p><p><strong>临时目录创建</strong>：临时根目录通过<code>TempDirectory.location()</code>获取，前缀默认使用<code>tomcat</code>，后缀使用配置端口，中间值使用<code>SecureRandom.nextLong()</code>获取随机数。</p><p>Windows临时目录：<code>C:\\Users\\lenovo\\AppData\\Local\\Temp</code></p><p><strong>Tomcat Servlet容器配置：</strong></p><p><code>TomcatServletWebServerFactory.getWebServer()</code></p><ol><li>创建连接器：默认使用<code>org.apache.coyote.http11.Http11NioProtocol</code>，属性<code>protocol</code>可配置该连接器类型。</li><li>创建在临时目录中创建工作目录，并设置连接器。</li><li>连接器设置<code>Server</code>绑定的地址；使用<code>TomcatProtocolHandlerCustomizer</code>实例对<code>ProtocolHandler</code>自定义(默认没有)；连接器设置默认URL编码(默认UTF-8)；设置延迟初始容器socket(避免ApplicationContext初始化慢的情况)；是否设置<code>ssl</code>连接(其中有判断使用使用http2协议)；是否设置自定义<code>TomcatConnectorCustomizer</code>连接器压缩；对连接器进行自定义。 <ol><li><code>AbstractProtocol</code>设置最大工作线程数(默认200)，配置方式：<code>server.tomcat.maxThreads</code>；</li><li><code>AbstractProtocol</code>设置最小工作线程数(默认10)，配置方式：<code>server.tomcat.minSpareThreads</code>；</li><li><code>AbstractHttp11Protocol</code>设置http请求头最大容量(默认8KB)，配置方式：<code>server.tomcat.maxHttpHeaderSize</code>；</li><li><code>AbstractHttp11Protocol</code>设置http请求体最大容量(默认2MB)，配置方式：<code>server.tomcat.maxSwallowSize</code>；</li><li><code>Connector</code>设置http表单最大容量(默认2MB)，配置方式：<code>server.tomcat.maxHttpFormPostSize</code>；</li><li><code>AbstractProtocol</code>设置最大连接数(默认8192)，配置方式：<code>server.tomcat.maxConnections</code>；</li><li><code>AbstractProtocol</code>设置当线程都在使用时，传入连接请求的最大队列长度(默认100)，配置方式：<code>server.tomcat.acceptCount</code>；</li><li><code>AbstractProtocol</code>设置将保留在缓存中并在后续请求中重用的空闲处理器的最大数量(默认200)。设为-1，表示缓存是无限的，理论大小等于最大连接数。配置方式：<code>server.tomcat.processorCache</code>；</li></ol></li><li>再次将连接器绑定到tomcat，为什么这样做？</li><li>Tomcat 服务设置默认引擎；设置延迟<code>server.tomcat.backgroundProcessorDelay</code>默认10s；</li><li>如果有配置其它连接器，则在tomcat上添加连接器；</li><li>一些固定设置；</li><li>重写<code>postProcessContext</code>方法调用；</li></ol><p><code>TomcatServletWebServerFactory.getTomcatWebServer(Tomcat tomcat)</code>：</p><ol><li>创建<code>TomcatWebServer</code>对象，打印<code>Tomcat initialized with port(s)</code>+端口+协议日志；</li><li>是否重写设置引擎名称，格式Tomcat-i；</li><li>删除服务连接器，以免协议绑定在服务启动时发生。<strong>为什么？</strong></li><li>Tocat启动。调用<code>StandardServer</code>父类<code>start()</code>方法。触发之前注册的监听器。 <ol><li>创建一个优先级为1，核心线程数2的<code>ScheduledThreadPoolExecutor</code>，线程名称前缀<code>Catalina-utility-</code>；</li><li>注册缓存，作用？</li><li>注册<code>MBeanFactory</code> ，作用？</li><li>注册<code>naming resources</code>，和Server一样，也有状态；</li><li>初始化定义Service，和Server一样，也有状态；</li><li>启动Serive，打印日志<code>Starting service</code> + 服务名，启动引擎。</li></ol></li><li>启动之后，由于Tomcat所有线程都是守护线程，创建一个阻塞非守护线程，用来关闭Server，线程名<code>container-i</code>；</li></ol><p>**finishRefresh()**调用<code>startWebServer()</code>启动Tomcat容器。最后发布<code>ServletWebServerInitializedEvent</code>事件。</p><h3 id="处理请求线程池创建" tabindex="-1"><a class="header-anchor" href="#处理请求线程池创建"><span>处理请求线程池创建</span></a></h3><p>队列使用<code>TaskQueue</code>，继承<code>LinkedBlockingQueue</code>，队列类型为<code>Runnable</code>，创建队列的容量默认是最大。</p><p>使用tomcat自定义的<code>TaskThreadFactory</code>线程工厂，线程名称前缀<code>http-nio-[port]-exec</code>，线程优先级5，默认都是守护线程。</p><p>线程池<code>ThreadPoolExecutor</code>，继承<code>java.util.concurrent.ThreadPoolExecutor</code>。初始化默认就激活了最小数量(核心线程数)的线程。拒绝策略，抛出<code>RejectedExecutionException</code>异常。</p><p><strong>Tomcat线程池execute(Runnable command)执行逻辑：</strong></p><p>线程池的逻辑没有大改，而是通过重写自定义<code>TaskQueue</code>阻塞队列的<code>offer</code>方法，来改变线程池的逻辑。</p><p>重写了线程池<code>afterExecute</code>，在任务执行完毕后调用。作用是：当前线程使用数量计数减一，判断是否需要停止当前线程。<strong>TaskQueue队列的poll方法也调用了是否关闭线程的方法，take方法相同。</strong></p><p><strong>正在处理的请求的线程超过核心线程数，开始激活其它线程处理请求。</strong></p><figure><img src="http://47.101.155.205/image-20250410193337369.png" alt="image-20250410193337369" tabindex="0" loading="lazy"><figcaption>image-20250410193337369</figcaption></figure><h3 id="影响tomcat处理请求配置" tabindex="-1"><a class="header-anchor" href="#影响tomcat处理请求配置"><span>影响tomcat处理请求配置</span></a></h3><div class="language-properties" data-highlighter="prismjs" data-ext="properties" data-title="properties"><pre><code><span class="line"><span class="token comment"># tomcat最大连接数</span></span>
<span class="line"><span class="token key attr-name">server.tomcat.maxConnections</span><span class="token punctuation">=</span><span class="token value attr-value">100</span></span>
<span class="line"><span class="token comment"># 请求的最大队列长度</span></span>
<span class="line"><span class="token key attr-name">server.tomcat.acceptCount</span><span class="token punctuation">=</span><span class="token value attr-value">100</span></span>
<span class="line"><span class="token comment"># 最大工作线程</span></span>
<span class="line"><span class="token key attr-name">server.tomcat.maxThreads</span><span class="token punctuation">=</span><span class="token value attr-value">300</span></span>
<span class="line"><span class="token comment"># 最小工作线程</span></span>
<span class="line"><span class="token key attr-name">server.tomcat.minSpareThreads</span><span class="token punctuation">=</span><span class="token value attr-value">10</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p><strong>使用jmeter发起300个请求，每个请求睡眠3s。100个请求耗时3s，100个请求耗时大于3s小于6s，100个请求失败。</strong></p><p><strong>没有超过6s，可能是jmeter发起请求时有部分耗时。</strong></p><p><strong>说明tomcat处理请求的并发数量由最大连接数和队列长度决定。超过最大连接数的数量会先进入等待队列(TCP连接以及建立)，待前面请求处理完成(释放连接)，再分发到工作线程处理请求。</strong></p><figure><img src="http://47.101.155.205/image-20250410203715184.png" alt="image-20250410203715184" tabindex="0" loading="lazy"><figcaption>image-20250410203715184</figcaption></figure><figure><img src="http://47.101.155.205/image-20250410203841146.png" alt="image-20250410203841146" tabindex="0" loading="lazy"><figcaption>image-20250410203841146</figcaption></figure><figure><img src="http://47.101.155.205/image-20250410210201475.png" alt="image-20250410210201475" tabindex="0" loading="lazy"><figcaption>image-20250410210201475</figcaption></figure><h3 id="tomcat线程模型" tabindex="-1"><a class="header-anchor" href="#tomcat线程模型"><span>Tomcat线程模型</span></a></h3><figure><img src="http://47.101.155.205/image-20250410212000843.png" alt="image-20250410212000843" tabindex="0" loading="lazy"><figcaption>image-20250410212000843</figcaption></figure><p><code>Acceptor</code>线程接收新连接，注册到<code>Poller</code>线程的<code>Selector</code>中。</p><p><code>Poller</code>线程负责监听Socket事件(通过<code>Selector</code>)，检测到就绪事件后封装成Runnable分发给工作线程。</p><figure><img src="http://47.101.155.205/image-20250410213126229.png" alt="image-20250410213126229" tabindex="0" loading="lazy"><figcaption>image-20250410213126229</figcaption></figure><h2 id="undertow容器启动过程" tabindex="-1"><a class="header-anchor" href="#undertow容器启动过程"><span>Undertow容器启动过程</span></a></h2><h3 id="_1-配置serverfactory工厂" tabindex="-1"><a class="header-anchor" href="#_1-配置serverfactory工厂"><span>1.配置ServerFactory工厂</span></a></h3><p>通用<code>ServletWebServerFactoryCustomizer</code>配置。</p><p>UndertowWebServerFactoryCustomizer</p><figure><img src="http://47.101.155.205/image-20250411204056905.png" alt="image-20250411204056905" tabindex="0" loading="lazy"><figcaption>image-20250411204056905</figcaption></figure><figure><img src="http://47.101.155.205/image-20250411204239303.png" alt="image-20250411204239303" tabindex="0" loading="lazy"><figcaption>image-20250411204239303</figcaption></figure><ol><li>server配置，配置请求头最大大小(<code>server.maxHttpHeaderSize=8KB</code>)，连接超时时间(<code>server.connectionTimeout=null</code>)；通过往工厂添加自定义器<code>UndertowBuilderCustomizer</code>对象设置配置。</li><li><code>server.undertow</code>配置 <ol><li><code>bufferSize=null</code>，每个缓存区的大小，默认来自JVM可以最大内存；</li><li><code>ioThreads=null</code>，I/O工作线程线程数，默认是可用处理器数量<code>Runtime.getRuntime().availableProcessors()</code>；</li><li><code>workerThreads=null</code>，工作中线程数，默认是I/O线程8倍；</li><li><code>directBuffers=null</code>，是否在Java堆外分配缓冲区。默认来自JVM可以最大内存；</li><li><code>maxHttpPostSize=-1</code>，Http Post请求最大大小，-1表示无限制；通过<code>UndertowBuilderCustomizer</code>设置；</li><li><code>maxParameters=1000</code>，查询参数或路径参数最大数量，为了避免基于哈希冲突的Dos攻击；</li><li><code>maxHeaders=200</code>，请求头最大数量，为了避免基于哈希冲突的Dos攻击；</li><li><code>maxCookies=200</code>，Cookie最大数量，为了避免基于哈希冲突的Dos攻击；</li><li><code>allowEncodedSlash=false</code>，服务器是否应该解码百分比编码斜杠字符。由于不同的服务器对斜杠的解释不同，启用编码斜杠可能会带来安全隐患。只有在遗留应用程序需要它时才启用它。</li><li><code>decodeUrl=true</code>，是否对URL进行解码。当禁用时，URL中的百分比编码字符将保持原样。</li><li><code>urlCharset=UTF-8</code>，解码使用的字符集；</li><li><code>alwaysSetKeepAlive=true</code>，是否在所有响应头中添加<code>Connection=keep-alive</code>；</li><li><code>noRequestTimeout=null</code>，连接超过此时间没有请求，则关闭连接；</li><li><code>options.server=map</code>，key要遵循<code>UndertowOptions</code>类中静态属性名称<code>Option</code>规则。</li><li><code>options.socket=map</code>，</li></ol></li><li><code>server.undertow.accesslog</code>配置 <ol><li><code>enabled=false</code>，是否开启访问日志；</li><li><code>dir=logs</code>，访问日志目录；</li><li><code>pattern=common</code>，日志格式；</li><li><code>prefix=access_log.</code>，日志文件前缀；</li><li><code>suffix=log</code>，日志文件后缀；</li><li><code>rotate=true</code>，是否启用日志轮换；</li></ol></li><li><code>server.forwardHeadersStrategy=null</code>，配置根据请求头转发策略；是否使用<code>x-forward-</code>头转发请求策略，默认false；</li></ol><h3 id="_2-根据serverfactory创建server" tabindex="-1"><a class="header-anchor" href="#_2-根据serverfactory创建server"><span>2.根据ServerFactory创建Server</span></a></h3><figure><img src="http://47.101.155.205/image-20250411210309520.png" alt="image-20250411210309520" tabindex="0" loading="lazy"><figcaption>image-20250411210309520</figcaption></figure><figure><img src="http://47.101.155.205/image-20250411210240459.png" alt="image-20250411210240459" tabindex="0" loading="lazy"><figcaption>image-20250411210240459</figcaption></figure><figure><img src="http://47.101.155.205/image-20250411205238518.png" alt="image-20250411205238518" tabindex="0" loading="lazy"><figcaption>image-20250411205238518</figcaption></figure><ol><li>容器的一些固定设置+SpringMVC打通；</li><li>容器的Bulder固定设置；在这个过程中，对Builder执行自定义的<code>UndertowBuilderCustomizer</code>操作；<code>addHttpListener</code>添加一个Server监听器，供启动Server使用；</li><li>创建<code>UndertowServletWebServer</code> Server对象；</li></ol><p><strong>获取默认I/O线程，及缓冲区配置的地方</strong></p><figure><img src="http://47.101.155.205/image-20250411212041842.png" alt="image-20250411212041842" tabindex="0" loading="lazy"><figcaption>image-20250411212041842</figcaption></figure><h3 id="_3-启动容器" tabindex="-1"><a class="header-anchor" href="#_3-启动容器"><span>3.启动容器</span></a></h3><figure><img src="http://47.101.155.205/image-20250411210739993.png" alt="image-20250411210739993" tabindex="0" loading="lazy"><figcaption>image-20250411210739993</figcaption></figure><figure><img src="http://47.101.155.205/image-20250411211121573.png" alt="image-20250411211121573" tabindex="0" loading="lazy"><figcaption>image-20250411211121573</figcaption></figure><figure><img src="http://47.101.155.205/image-20250413134827936.png" alt="image-20250413134827936" tabindex="0" loading="lazy"><figcaption>image-20250413134827936</figcaption></figure><figure><img src="http://47.101.155.205/image-20250413135817087.png" alt="image-20250413135817087" tabindex="0" loading="lazy"><figcaption>image-20250413135817087</figcaption></figure><p><strong>Undertow.start()</strong></p><ol><li>获取Undertow容器版本；</li><li>先通过<code>ServiceLoader.load(XnioProvider.class, classLoader)</code>创建Xnio对象。再创建<code>NioXnioWorker</code>对象： <ol><li>创建工作线程池<code>TaskPool</code>，重写<code>terminated()</code>方法。默认情况下，核心线程数就等于最大线程数、使用无界阻塞队列、使用AbortPolicy拒绝策略、线程工厂使用<code>AccessController.doPrivileged(.)</code>创建线程对象，线程组为null，线程空闲时间60s，是否守护线程可配置，默认线程名称<strong>XNIO-i task-i(XNIO-i是默认自动生成前缀，名称可配置)</strong>。</li><li>创建工作I/O线程集合，<code>WorkerThread</code>线程集合。线程名称：<strong>XNIO-i I/O-j(j从1开始，累加)</strong></li><li>创建工作Accept线程，<code>WorkerThread</code>线程。线程名称：<strong>XNIO-i Accept</strong>。</li><li>注册MBean。</li><li><code>NioXnioWorker</code>调用<code>start()</code>。启动I/O线程和Accept线程。</li></ol></li><li>默认的Socket配置设置，以及自定义的Socket配置设置： <ol><li><code>Options.WORKER_IO_THREADS</code>配置I/O工作线程数量。</li><li><code>Options.TCP_NODELAY</code>配置是否禁用Nagle算法；开启会有延迟。</li><li><code>Options.REUSE_ADDRESSES</code>是否复用绑定的ip地址。</li><li><code>Options.BALANCING_TOKENS</code>连接平衡配置，默认没有用。</li><li><code>Options.BALANCING_CONNECTIONS</code>连接平衡配置，默认没有用。</li><li><code>Options.BACKLOG</code>连接满了的队列上限；</li><li>其它自定义配置，可覆盖前面的配置。</li></ol></li><li>默认的Server配置设置，以及自定义Server配置设置： <ol><li><code>UndertowOptions.NO_REQUEST_TIMEOUT</code>连接空闲时间，新建TCP连接，超过时间未发送请求头数据关闭连接。</li><li>其它自定义配置，可覆盖前面的配置。</li></ol></li><li>根据配置的<code>byteBufferPool</code>设置缓冲区大小，默认情况见<code>2</code>中说明。</li><li>注册监听。</li></ol><p><strong>使用服务发现机制创建加载实现：xnio实例NioXnio</strong></p><figure><img src="http://47.101.155.205/image-20250413144337108.png" alt="image-20250413144337108" tabindex="0" loading="lazy"><figcaption>image-20250413144337108</figcaption></figure><p><strong><code>NioXnioWorker</code>构造方法执行情况：</strong></p><figure><img src="http://47.101.155.205/image-20250413141905794.png" alt="image-20250413141905794" tabindex="0" loading="lazy"><figcaption>image-20250413141905794</figcaption></figure><p>通过<code>Class.getResourceAsStream(&quot;path&quot;)</code>获取jar包中的properties文件(获取Undertow容器版本)：</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Version</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> versionString<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">SERVER_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;Undertow&quot;</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> fullVersionString<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">static</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name">String</span> version <span class="token operator">=</span> <span class="token string">&quot;Unknown&quot;</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> versionPropsStream <span class="token operator">=</span> <span class="token class-name">Version</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">&quot;version.properties&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            props<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>versionPropsStream<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            version <span class="token operator">=</span> props<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;undertow.version&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        versionString <span class="token operator">=</span> version<span class="token punctuation">;</span></span>
<span class="line">        fullVersionString <span class="token operator">=</span> <span class="token constant">SERVER_NAME</span> <span class="token operator">+</span> <span class="token string">&quot; - &quot;</span><span class="token operator">+</span> versionString<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getVersionString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> versionString<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getFullVersionString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fullVersionString<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-线程模型" tabindex="-1"><a class="header-anchor" href="#_4-线程模型"><span>4.线程模型</span></a></h3><figure><img src="http://47.101.155.205/image-20250411215838406.png" alt="image-20250411215838406" tabindex="0" loading="lazy"><figcaption>image-20250411215838406</figcaption></figure><p><strong>在16核的Windows机器上，没有任何Undertow相关配置。</strong></p><p>启动之后，线程情况：1个<code>XNIO-1 Accept</code>线程，16个<code>XNIO-1 I/O-</code>I/O线程，没有创建工作线程。</p><p>通过jmeter发起300并发请求，<code>XNIO-1 task-</code>工作线程数量128，没有请求失败，最长请求时间没有超过9s（可能是建立TCP连接需要耗时，导致没有到9s）。</p><figure><img src="http://47.101.155.205/image-20250411215922678.png" alt="image-20250411215922678" tabindex="0" loading="lazy"><figcaption>image-20250411215922678</figcaption></figure><p><strong>同时处理请求的数量受工作线程限制。</strong></p><p><strong>Undertow创建工作线程(Worker)的配置：</strong></p><figure><img src="http://47.101.155.205/image-20250413123724964.png" alt="image-20250413123724964" tabindex="0" loading="lazy"><figcaption>image-20250413123724964</figcaption></figure><h3 id="_5-自定义容器配置" tabindex="-1"><a class="header-anchor" href="#_5-自定义容器配置"><span>5.自定义容器配置</span></a></h3><p>通过注入<code>UndertowBuilderCustomizer</code> Bean对<code>Undertow.Builder</code>对象自定义配置。</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>undertow<span class="token punctuation">.</span></span><span class="token class-name">Undertow</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">io<span class="token punctuation">.</span>undertow<span class="token punctuation">.</span></span><span class="token class-name">UndertowOptions</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>web<span class="token punctuation">.</span>embedded<span class="token punctuation">.</span>undertow<span class="token punctuation">.</span></span><span class="token class-name">UndertowBuilderCustomizer</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>xnio<span class="token punctuation">.</span></span><span class="token class-name">Options</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token annotation punctuation">@Configuration</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomUndertowConfig</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">    <span class="token annotation punctuation">@Bean</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token class-name">UndertowBuilderCustomizer</span> <span class="token function">myUndertowCustom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CustomBuild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CustomBuild</span> <span class="token keyword">implements</span> <span class="token class-name">UndertowBuilderCustomizer</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">        <span class="token annotation punctuation">@Override</span></span>
<span class="line">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">customize</span><span class="token punctuation">(</span><span class="token class-name">Undertow<span class="token punctuation">.</span>Builder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// worker</span></span>
<span class="line">            <span class="token comment">// 覆盖io线程数量配置</span></span>
<span class="line">            builder<span class="token punctuation">.</span><span class="token function">setWorkerOption</span><span class="token punctuation">(</span><span class="token class-name">Options</span><span class="token punctuation">.</span><span class="token constant">WORKER_IO_THREADS</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// 修改线程名称前缀</span></span>
<span class="line">            builder<span class="token punctuation">.</span><span class="token function">setWorkerOption</span><span class="token punctuation">(</span><span class="token class-name">Options</span><span class="token punctuation">.</span><span class="token constant">WORKER_NAME</span><span class="token punctuation">,</span> <span class="token string">&quot;Undertow&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// 修改工作线程数</span></span>
<span class="line">            builder<span class="token punctuation">.</span><span class="token function">setWorkerOption</span><span class="token punctuation">(</span><span class="token class-name">Options</span><span class="token punctuation">.</span><span class="token constant">WORKER_TASK_MAX_THREADS</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            builder<span class="token punctuation">.</span><span class="token function">setWorkerOption</span><span class="token punctuation">(</span><span class="token class-name">Options</span><span class="token punctuation">.</span><span class="token constant">WORKER_TASK_CORE_THREADS</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// Socket</span></span>
<span class="line">            <span class="token comment">// 配置连接阈值 失败数量不稳定</span></span>
<span class="line">            builder<span class="token punctuation">.</span><span class="token function">setSocketOption</span><span class="token punctuation">(</span><span class="token class-name">Options</span><span class="token punctuation">.</span><span class="token constant">CONNECTION_HIGH_WATER</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            builder<span class="token punctuation">.</span><span class="token function">setSocketOption</span><span class="token punctuation">(</span><span class="token class-name">Options</span><span class="token punctuation">.</span><span class="token constant">CONNECTION_LOW_WATER</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">//</span></span>
<span class="line">            builder<span class="token punctuation">.</span><span class="token function">setSocketOption</span><span class="token punctuation">(</span><span class="token class-name">UndertowOptions</span><span class="token punctuation">.</span><span class="token constant">QUEUED_FRAMES_HIGH_WATER_MARK</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            builder<span class="token punctuation">.</span><span class="token function">setSocketOption</span><span class="token punctuation">(</span><span class="token class-name">UndertowOptions</span><span class="token punctuation">.</span><span class="token constant">QUEUED_FRAMES_HIGH_WATER_MARK</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// 配置连接队列</span></span>
<span class="line">            builder<span class="token punctuation">.</span><span class="token function">setSocketOption</span><span class="token punctuation">(</span><span class="token class-name">Options</span><span class="token punctuation">.</span><span class="token constant">BACKLOG</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// 配置读写超时时间</span></span>
<span class="line">            builder<span class="token punctuation">.</span><span class="token function">setSocketOption</span><span class="token punctuation">(</span><span class="token class-name">Options</span><span class="token punctuation">.</span><span class="token constant">READ_TIMEOUT</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            builder<span class="token punctuation">.</span><span class="token function">setSocketOption</span><span class="token punctuation">(</span><span class="token class-name">Options</span><span class="token punctuation">.</span><span class="token constant">WRITE_TIMEOUT</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            builder<span class="token punctuation">.</span><span class="token function">setSocketOption</span><span class="token punctuation">(</span><span class="token class-name">UndertowOptions</span><span class="token punctuation">.</span><span class="token constant">REQUEST_PARSE_TIMEOUT</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// Server</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// TCP连接建立后，第一个HTTP请求到达前的空闲等待时间</span></span>
<span class="line">            builder<span class="token punctuation">.</span><span class="token function">setServerOption</span><span class="token punctuation">(</span><span class="token class-name">UndertowOptions</span><span class="token punctuation">.</span><span class="token constant">NO_REQUEST_TIMEOUT</span><span class="token punctuation">,</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// 两个连续请求之间的空闲时间(Keep-Alive连接) 超过关闭连接</span></span>
<span class="line">            builder<span class="token punctuation">.</span><span class="token function">setServerOption</span><span class="token punctuation">(</span><span class="token class-name">UndertowOptions</span><span class="token punctuation">.</span><span class="token constant">IDLE_TIMEOUT</span><span class="token punctuation">,</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token comment">// 并发请求配置</span></span>
<span class="line">            <span class="token comment">//builder.setServerOption(UndertowOptions.MAX_CONCURRENT_REQUESTS_PER_CONNECTION, 5);</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-linux查询jvm可以处理器" tabindex="-1"><a class="header-anchor" href="#_6-linux查询jvm可以处理器"><span>6.Linux查询JVM可以处理器</span></a></h3><p><strong>非容器环境(逻辑核心数)：</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">nproc</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查询文件中processro的数量</span></span>
<span class="line"><span class="token function">grep</span> <span class="token parameter variable">-c</span> <span class="token string">&#39;^processor&#39;</span> /proc/cpuinfo</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 显示CPU的信息</span></span>
<span class="line">lscpu</span>
<span class="line"></span>
<span class="line">lscpu <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">&#39;^CPU(s):&#39;</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">&#39;{print $2}&#39;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="http://47.101.155.205/image-20250417135540463.png" alt="image-20250417135540463" tabindex="0" loading="lazy"><figcaption>image-20250417135540463</figcaption></figure><p><strong>容器化环境：</strong></p><div class="language-bash" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token comment"># 查询容器时间配额, -1表示未限制(同非容器处理器数量)</span></span>
<span class="line"><span class="token function">cat</span> /sys/fs/cgroup/cpu/cpu.cfs_quota_us</span>
<span class="line"></span>
<span class="line"><span class="token comment"># CPU 时间周期(默认100000，0.1秒)</span></span>
<span class="line"><span class="token function">cat</span> /sys/fs/cgroup/cpu/cpu.cfs_period_us</span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p><strong>容器可以处理器数量 = 容器配额时间 / 时间周期</strong></p>`,177)]))}const l=a(t,[["render",i],["__file","starter-embedded.html.vue"]]),r=JSON.parse('{"path":"/springboot/starter-embedded.html","title":"嵌入式容器starter","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"Servlet自动配置","slug":"servlet自动配置","link":"#servlet自动配置","children":[{"level":3,"title":"1.ServletWebServerFactoryAutoConfiguration","slug":"_1-servletwebserverfactoryautoconfiguration","link":"#_1-servletwebserverfactoryautoconfiguration","children":[]},{"level":3,"title":"2.DispatcherServletAutoConfiguration","slug":"_2-dispatcherservletautoconfiguration","link":"#_2-dispatcherservletautoconfiguration","children":[]},{"level":3,"title":"3.ErrorMvcAutoConfiguration","slug":"_3-errormvcautoconfiguration","link":"#_3-errormvcautoconfiguration","children":[]},{"level":3,"title":"4.WebMvcAutoConfiguration","slug":"_4-webmvcautoconfiguration","link":"#_4-webmvcautoconfiguration","children":[]},{"level":3,"title":"5.HttpEncodingAutoConfiguration","slug":"_5-httpencodingautoconfiguration","link":"#_5-httpencodingautoconfiguration","children":[]},{"level":3,"title":"6.MultipartAutoConfiguration","slug":"_6-multipartautoconfiguration","link":"#_6-multipartautoconfiguration","children":[]}]},{"level":2,"title":"embedded自动配置","slug":"embedded自动配置","link":"#embedded自动配置","children":[]},{"level":2,"title":"Tomcat容器启动","slug":"tomcat容器启动","link":"#tomcat容器启动","children":[{"level":3,"title":"处理请求线程池创建","slug":"处理请求线程池创建","link":"#处理请求线程池创建","children":[]},{"level":3,"title":"影响tomcat处理请求配置","slug":"影响tomcat处理请求配置","link":"#影响tomcat处理请求配置","children":[]},{"level":3,"title":"Tomcat线程模型","slug":"tomcat线程模型","link":"#tomcat线程模型","children":[]}]},{"level":2,"title":"Undertow容器启动过程","slug":"undertow容器启动过程","link":"#undertow容器启动过程","children":[{"level":3,"title":"1.配置ServerFactory工厂","slug":"_1-配置serverfactory工厂","link":"#_1-配置serverfactory工厂","children":[]},{"level":3,"title":"2.根据ServerFactory创建Server","slug":"_2-根据serverfactory创建server","link":"#_2-根据serverfactory创建server","children":[]},{"level":3,"title":"3.启动容器","slug":"_3-启动容器","link":"#_3-启动容器","children":[]},{"level":3,"title":"4.线程模型","slug":"_4-线程模型","link":"#_4-线程模型","children":[]},{"level":3,"title":"5.自定义容器配置","slug":"_5-自定义容器配置","link":"#_5-自定义容器配置","children":[]},{"level":3,"title":"6.Linux查询JVM可以处理器","slug":"_6-linux查询jvm可以处理器","link":"#_6-linux查询jvm可以处理器","children":[]}]}],"git":{"updatedTime":1744869419000,"contributors":[{"name":"ouyangcm","username":"ouyangcm","email":"mingorg@163.com","commits":6,"url":"https://github.com/ouyangcm"},{"name":"oycm","username":"oycm","email":"1164864987@qq.com","commits":5,"url":"https://github.com/oycm"}]},"filePathRelative":"springboot/starter-embedded.md"}');export{l as comp,r as data};
